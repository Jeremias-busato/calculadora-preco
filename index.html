<script>
  function calcular() {
    const custo = parseFloat(document.getElementById('custo').value) || 0;
    const maoDeObra = parseFloat(document.getElementById('maoDeObra').value) || 0;
    const margemManual = parseFloat(document.getElementById('margemManual').value);

    // Função para interpolar o preço baseado no custo
    function obterPrecoBase(custo) {
      for (let i = 0; i < precosBase.length - 1; i++) {
        const atual = precosBase[i];
        const proximo = precosBase[i + 1];

        if (custo === atual.custo) return atual.preco;

        if (custo > atual.custo && custo < proximo.custo) {
          // Interpolação linear
          const proporcao = (custo - atual.custo) / (proximo.custo - atual.custo);
          return atual.preco + proporcao * (proximo.preco - atual.preco);
        }
      }

      // Se custo for maior que último item, extrapola linearmente
      const penultimo = precosBase[precosBase.length - 2];
      const ultimo = precosBase[precosBase.length - 1];
      const proporcaoFinal = (custo - penultimo.custo) / (ultimo.custo - penultimo.custo);
      return penultimo.preco + proporcaoFinal * (ultimo.preco - penultimo.preco);
    }

    const precoCheio = margemManual
      ? custo * (1 + margemManual / 100)
      : obterPrecoBase(custo);

    const margemCheia = ((precoCheio - custo) / custo) * 100;
    const valorMargemCheia = precoCheio - custo;

    const precoReduzido = precoCheio * 0.8;
    const margemReduzida = ((precoReduzido - custo) / custo) * 100;
    const valorMargemReduzida = precoReduzido - custo;

    // Atualiza os campos da tabela
    document.getElementById('margemCheia').textContent = isFinite(margemCheia) ? margemCheia.toFixed(1) + '%' : '-';
    document.getElementById('precoMargemCheio').textContent = valorMargemCheia.toFixed(2);
    document.getElementById('precoCheio').textContent = precoCheio.toFixed(2);

    document.getElementById('margemReduzida').textContent = isFinite(margemReduzida) ? margemReduzida.toFixed(1) + '%' : '-';
    document.getElementById('precoMargemReduzido').textContent = valorMargemReduzida.toFixed(2);
    document.getElementById('precoReduzido').textContent = precoReduzido.toFixed(2);

    if (maoDeObra > 0) {
      document.getElementById('maoDeObraCheioRow').style.display = '';
      document.getElementById('maoDeObraReduzidoRow').style.display = '';

      document.getElementById('precoCheioInstalacao').textContent = (precoCheio + maoDeObra).toFixed(2);
      document.getElementById('precoReduzidoInstalacao').textContent = (precoReduzido + maoDeObra).toFixed(2);

      const margemInstCheia = ((precoCheio + maoDeObra - custo) / custo) * 100;
      const margemInstReduzida = ((precoReduzido + maoDeObra - custo) / custo) * 100;

      document.getElementById('margemCheiaInst').textContent = isFinite(margemInstCheia) ? margemInstCheia.toFixed(1) + '%' : '-';
      document.getElementById('margemReduzidaInst').textContent = isFinite(margemInstReduzida) ? margemInstReduzida.toFixed(1) + '%' : '-';

      document.getElementById('precoMargemCheioInst').textContent = (precoCheio + maoDeObra - custo).toFixed(2);
      document.getElementById('precoMargemReduzidoInst').textContent = (precoReduzido + maoDeObra - custo).toFixed(2);
    } else {
      document.getElementById('maoDeObraCheioRow').style.display = 'none';
      document.getElementById('maoDeObraReduzidoRow').style.display = 'none';
    }
  }
</script>
